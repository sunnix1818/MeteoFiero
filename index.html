<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meteo World Pro ‚Ä¢ Previsioni Hyper-Local in Tempo Reale</title>
<meta name="description" content="Meteo World Pro √® l'app meteo professionale: previsioni iper-locali, radar, grafici orari e giornalieri, qualit√† dell'aria e allerte meteo in tempo reale.">
<meta name="keywords" content="meteo professionale, previsioni orarie, radar meteo, qualit√† aria, indice UV, allerte meteo, OpenWeather">
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#020817">
<link rel="manifest" href="data:application/manifest+json,{
  'name':'Meteo World Pro',
  'short_name':'MeteoPro',
  'display':'standalone',
  'start_url':'./',
  'background_color':'#020817',
  'theme_color':'#020817',
  'icons':[{
    'src':'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGxpbmVhckdyYWRpZW50IGlkPSJnIiB4MT0iMCIgeTE9IjAiIHgyPSIxIiB5Mj0iMSI+PHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjNGZhY2ZlIi8+PHN0b3Agb2Zmc2V0PSIwLjUiIHN0b3AtY29sb3I9IiMwMGYyZmUiLz48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiMwMjA4MTciLz48L2xpbmVhckdyYWRpZW50PjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMzIiIGZpbGw9InVybCgjZykiLz48Y2lyY2xlIGN4PSI5NiIgY3k9IjcyIiByPSIzMiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik0xMzIgMTE2QzEzMiAxMzYuMjA5IDExNi4yMDkgMTUyIDk2IDE1MkM3NS43OTE0IDE1MiA2MCAxMzYuMjA5IDYwIDExNkM2MCA5NS43OTE0IDc1Ljc5MTQgODAgOTYgODBIMTAyQzExNi43MjggODAgMTI4IDkxLjI3MiAxMjggMTA2VjExNk0xMDggNjRDOTcuNDkzNCA2NCA4OCA3My40OTM0IDg4IDg0SDk2QzExMC43MjggODQgMTIyIDcyLjcyOCAxMjIgNTRDMTIyIDM1LjI3MiAxMTAuNzI4IDI0IDk2IDI0QzgxLjI3MTggMjQgNzAgMzUuMjcyIDcwIDU0SDY4QzY4IDMyLjM1OSA4NS4zNTkgMTUgMTA3LjY0IDE1QzEyOS45MiAxNSAxNDcgMzIuMzU5IDE0NyA1NEMxNDcgNzUuNjQxIDEyOS42NDEgOTMgMTA4IDkzVjY0WiIgZmlsbD0iI2Q4MjUyZiIvPjwvc3ZnPg==',
    'sizes':'192x192',
    'type':'image/svg+xml'
  }]
}">
<style>
:root{
  --bg-main:#020817;
  --bg-card:#020617;
  --bg-glass:rgba(15,23,42,.8);
  --accent:#38bdf8;
  --accent-soft:rgba(56,189,248,.25);
  --accent-strong:#0ea5e9;
  --text-main:#e5e7eb;
  --text-muted:#9ca3af;
  --danger:#f97373;
  --success:#4ade80;
  --warning:#facc15;
  --radius-xl:28px;
  --radius-lg:20px;
  --shadow-strong:0 25px 80px rgba(0,0,0,.75);
  --shadow-soft:0 16px 40px rgba(15,23,42,.9);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
  min-height:100vh;
  background:radial-gradient(circle at 0 0,#1d4ed8 0,#020617 40%,#000 100%);
  color:var(--text-main);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:16px;
}
.app-shell{
  width:min(100%,1140px);
  max-height:96vh;
  border-radius:var(--radius-xl);
  padding:24px;
  background:linear-gradient(135deg,rgba(15,23,42,.96),rgba(2,6,23,.98));
  box-shadow:var(--shadow-strong);
  display:grid;
  grid-template-columns:2.1fr 1.4fr;
  gap:20px;
  position:relative;
  overflow:hidden;
  border:1px solid rgba(148,163,184,.35);
}
.app-shell::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(circle at 10% 10%,rgba(56,189,248,.35),transparent 55%),
    radial-gradient(circle at 90% 0,rgba(59,130,246,.16),transparent 55%),
    radial-gradient(circle at 10% 90%,rgba(34,197,94,.18),transparent 55%);
  opacity:.5;
  filter:blur(25px);
  z-index:0;
}
.app-main,.app-side{position:relative;z-index:1;}

/* Header */
.app-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.app-title{
  display:flex;
  align-items:center;
  gap:10px;
}
.app-title span.icon{
  font-size:1.7rem;
  filter:drop-shadow(0 0 12px rgba(56,189,248,.8));
}
.app-title h1{
  font-size:1.35rem;
  font-weight:700;
  letter-spacing:.03em;
}
.app-badge{
  font-size:.68rem;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(96,165,250,.6);
  background:linear-gradient(135deg,rgba(15,23,42,.9),rgba(30,64,175,.95));
  color:var(--accent);
  text-transform:uppercase;
  letter-spacing:.12em;
}

/* Search bar */
.controls{
  display:grid;
  grid-template-columns:1.4fr 1fr auto;
  gap:8px;
  margin-bottom:10px;
}
input,select,button{
  border-radius:999px;
  border:1px solid rgba(148,163,184,.45);
  padding:11px 14px;
  background:radial-gradient(circle at 0 0,rgba(15,23,42,.95),rgba(15,23,42,.98));
  color:var(--text-main);
  font-size:.88rem;
  outline:none;
  transition:border .2s,box-shadow .2s,background .2s,transform .1s;
}
input::placeholder{color:var(--text-muted);}
input:focus,select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 1px rgba(56,189,248,.6),0 0 30px rgba(8,47,73,.7);
}
select{
  appearance:none;
  background-image:linear-gradient(45deg,transparent 50%,var(--accent) 50%),linear-gradient(135deg,var(--accent) 50%,transparent 50%);
  background-position:calc(100% - 16px) calc(50% - 3px),calc(100% - 11px) calc(50% - 3px);
  background-size:7px 7px,7px 7px;
  background-repeat:no-repeat;
}
.btn-primary{
  background:radial-gradient(circle at 0 0,#38bdf8,#0ea5e9);
  border-color:rgba(56,189,248,.9);
  font-weight:600;
  box-shadow:0 12px 35px rgba(56,189,248,.45);
  white-space:nowrap;
}
.btn-primary:hover{
  transform:translateY(-1px);
  box-shadow:0 20px 45px rgba(56,189,248,.6);
}
.btn-primary:active{transform:translateY(0);}

/* Main current card */
.card{
  background:linear-gradient(145deg,rgba(15,23,42,.98),rgba(2,6,23,.98));
  border-radius:24px;
  padding:18px 18px 16px;
  border:1px solid rgba(75,85,99,.7);
  box-shadow:var(--shadow-soft);
  position:relative;
  overflow:hidden;
}
.card::before{
  content:"";
  position:absolute;
  inset:-60%;
  background:radial-gradient(circle at 0 0,rgba(56,189,248,.25),transparent 55%);
  opacity:.55;
  filter:blur(20px);
  z-index:0;
}
.card-content{position:relative;z-index:1;}
.card-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:6px;
}
.location-block{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.location-name{
  font-size:1.15rem;
  font-weight:600;
}
.location-meta{
  font-size:.76rem;
  color:var(--text-muted);
}
.time-tag{
  font-size:.68rem;
  padding:3px 9px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.6);
  background:rgba(15,23,42,.9);
  color:var(--accent);
}
.temp-block{
  display:flex;
  align-items:center;
  gap:14px;
}
.temp-main{
  font-size:2.8rem;
  font-weight:800;
  letter-spacing:.03em;
  text-shadow:0 10px 30px rgba(15,23,42,1);
}
.temp-extra{
  display:flex;
  flex-direction:column;
  font-size:.78rem;
  color:var(--text-muted);
}
.temp-extra span strong{color:var(--accent);}

/* Condition row */
.condition-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:4px 0 10px;
}
.condition-main{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:.98rem;
}
.condition-icon{
  font-size:1.7rem;
  filter:drop-shadow(0 0 16px rgba(56,189,248,.85));
}
.condition-label{
  text-transform:capitalize;
}
.chip-row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  font-size:.7rem;
}
.chip{
  padding:4px 8px;
  border-radius:999px;
  background:rgba(15,23,42,.96);
  border:1px solid rgba(55,65,81,.9);
  color:var(--text-muted);
}
.chip strong{color:var(--accent-soft);}

/* Grid metrics */
.metrics-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-top:6px;
}
.metric{
  background:radial-gradient(circle at 0 0,rgba(15,23,42,.98),rgba(15,23,42,.98));
  border-radius:18px;
  padding:10px 10px 9px;
  border:1px solid rgba(55,65,81,.9);
  font-size:.8rem;
}
.metric-label{
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:var(--text-muted);
}
.metric-value{
  margin-top:5px;
  font-weight:600;
  font-size:.98rem;
}
.metric-pill{
  margin-top:2px;
  font-size:.7rem;
  color:var(--text-muted);
}

/* Hourly strip */
.hourly-strip{
  margin-top:12px;
  padding-top:10px;
  border-top:1px dashed rgba(55,65,81,.9);
}
.hourly-title{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:.8rem;
  color:var(--text-muted);
  margin-bottom:6px;
}
.hourly-list{
  display:flex;
  gap:8px;
  overflow-x:auto;
  padding-bottom:4px;
  scroll-snap-type:x mandatory;
}
.hour-pill{
  min-width:64px;
  scroll-snap-align:start;
  border-radius:16px;
  padding:6px 6px 7px;
  background:rgba(15,23,42,.98);
  border:1px solid rgba(55,65,81,.9);
  font-size:.74rem;
  text-align:center;
}
.hour-pill .h-time{color:var(--text-muted);font-size:.7rem;}
.hour-pill .h-icon{font-size:1.1rem;margin:2px 0;}
.hour-pill .h-temp{font-weight:600;}
.hour-pill .h-pop{font-size:.66rem;color:#38bdf8;}

/* Side column cards */
.side-card{
  background:var(--bg-glass);
  border-radius:22px;
  padding:14px 14px 12px;
  border:1px solid rgba(51,65,85,.9);
  box-shadow:0 14px 40px rgba(15,23,42,.9);
  margin-bottom:10px;
}
.side-title{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:.78rem;
  color:var(--text-muted);
  margin-bottom:2px;
}
.side-title strong{color:var(--text-main);font-size:.82rem;}
.side-tag{
  font-size:.64rem;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid rgba(56,189,248,.55);
  color:var(--accent);
}

/* Forecast days */
.forecast-grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
  margin-top:4px;
}
.day-pill{
  border-radius:18px;
  padding:8px 9px 7px;
  background:rgba(15,23,42,.98);
  border:1px solid rgba(55,65,81,.9);
  font-size:.8rem;
  display:grid;
  grid-template-columns:1.1fr .7fr;
  gap:3px;
}
.day-main{display:flex;flex-direction:column;gap:2px;}
.day-name{font-weight:500;}
.day-icon{font-size:1.1rem;}
.day-desc{font-size:.7rem;color:var(--text-muted);}
.day-temps{text-align:right;font-size:.78rem;}
.day-max{font-weight:600;}
.day-min{color:var(--text-muted);}

/* AQ / UV / details */
.detail-row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:4px;
}
.detail-badge{
  flex:1 1 80px;
  border-radius:16px;
  padding:8px 10px;
  border:1px solid rgba(55,65,81,.9);
  font-size:.75rem;
}
.detail-label{color:var(--text-muted);}
.detail-value{font-weight:600;margin-top:2px;}
.detail-badge.good .detail-value{color:var(--success);}
.detail-badge.moderate .detail-value{color:var(--warning);}
.detail-badge.bad .detail-value{color:var(--danger);}

/* Canvas */
#grafico{
  width:100%;
  height:130px;
  border-radius:18px;
  margin-top:6px;
  background:radial-gradient(circle at 0 0,rgba(15,23,42,.98),rgba(15,23,42,.98));
  border:1px solid rgba(55,65,81,.9);
}

/* Footer */
.app-footer{
  margin-top:6px;
  font-size:.7rem;
  color:var(--text-muted);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.app-footer a{
  color:var(--accent);
  text-decoration:none;
}

/* Status / error */
.status-bar{
  margin-top:6px;
  font-size:.74rem;
  color:var(--text-muted);
  display:flex;
  justify-content:space-between;
}
.status-dot{
  width:8px;height:8px;border-radius:999px;
}
.status-dot.ok{background:var(--success);}
.status-dot.offline{background:var(--warning);}
#error{
  display:none;
  margin-top:8px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(248,113,113,.8);
  background:rgba(127,29,29,.9);
  font-size:.76rem;
}

/* Loading shimmer */
.loading-skel{
  position:absolute;
  inset:0;
  background:linear-gradient(90deg,rgba(30,64,175,.1),rgba(56,189,248,.2),rgba(30,64,175,.1));
  background-size:220% 100%;
  animation:shimmer 1.6s infinite;
  opacity:.35;
  border-radius:inherit;
}
.loading-skel.hidden{display:none;}
@keyframes shimmer{
  0%{background-position:-120% 0;}
  100%{background-position:120% 0;}
}

/* Responsive */
@media (max-width:900px){
  .app-shell{
    grid-template-columns:1fr;
    max-height:none;
  }
  body{align-items:flex-start;}
}
@media (max-width:520px){
  .controls{
    grid-template-columns:1fr;
  }
}
</style>
</head>
<body>
<div class="app-shell" id="appShell">
  <div class="app-main">
    <header class="app-header">
      <div class="app-title">
        <span class="icon">üåê</span>
        <div>
          <h1>Meteo World Pro</h1>
          <div style="font-size:.74rem;color:var(--text-muted);">Previsioni hyper-local con precisione professionale</div>
        </div>
      </div>
      <div class="app-badge">Realtime Engine v3.0</div>
    </header>

    <div class="controls">
      <input id="citta" placeholder="Citt√†, CAP o coordinate (es: Roma ‚Ä¢ 00100 ‚Ä¢ 41.89,12.49)" autocomplete="off">
      <select id="cittaInternazionale">
        <option value="">üåç Citt√† rapide</option>
      </select>
      <button class="btn-primary" onclick="usaPosizione()" title="Geolocalizzazione precisa">üìç Live</button>
    </div>

    <div class="status-bar">
      <div style="display:flex;align-items:center;gap:6px;">
        <span class="status-dot ok" id="statusDot"></span>
        <span id="statusText">Online ‚Ä¢ stream dati aggiornato</span>
      </div>
      <span id="ultimoAgg">Ultimo aggiornamento: ‚Äî</span>
    </div>

    <button style="margin-top:6px;font-size:.76rem;padding:7px 14px;" onclick="cercaCitta()">üîç Cerca</button>
    <div id="error"></div>

    <section class="card" id="cardCurrent">
      <div class="loading-skel" id="loadingSkel"></div>
      <div class="card-content" id="meteo"></div>
    </section>

    <section class="card" style="margin-top:10px;">
      <div class="card-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:.8rem;color:var(--text-muted);">
          <span>Andamento temperatura ‚Ä¢ Prossimi 5 giorni</span>
          <span style="font-size:.7rem;">Max / Min ¬∞C</span>
        </div>
        <canvas id="grafico"></canvas>
      </div>
    </section>
  </div>

  <aside class="app-side">
    <section class="side-card">
      <div class="side-title">
        <strong>Previsione giornaliera</strong>
        <span class="side-tag">5 giorni</span>
      </div>
      <div id="previsioni" class="forecast-grid"></div>
    </section>

    <section class="side-card">
      <div class="side-title">
        <strong>Dettagli atmosfera</strong>
        <span class="side-tag">Pro live</span>
      </div>
      <div class="detail-row">
        <div class="detail-badge good">
          <div class="detail-label">Indice UV</div>
          <div class="detail-value" id="uvValue">‚Äî</div>
        </div>
        <div class="detail-badge moderate">
          <div class="detail-label">Qualit√† aria (AQI)</div>
          <div class="detail-value" id="aqiValue">‚Äî</div>
        </div>
        <div class="detail-badge">
          <div class="detail-label">Visibilit√†</div>
          <div class="detail-value" id="visValue">‚Äî</div>
        </div>
        <div class="detail-badge">
          <div class="detail-label">Copertura nuvole</div>
          <div class="detail-value" id="cloudValue">‚Äî</div>
        </div>
      </div>
    </section>

    <section class="side-card">
      <div class="side-title">
        <strong>Timeline oraria</strong>
        <span class="side-tag">Prossime 12 ore</span>
      </div>
      <div class="hourly-strip">
        <div class="hourly-title">
          <span>Vista rapida temperatura e rischio pioggia</span>
          <span id="hourlySummary">‚Äî</span>
        </div>
        <div id="hourlyList" class="hourly-list"></div>
      </div>
    </section>

    <footer class="app-footer">
      <span>Fonte dati: OpenWeather ‚Ä¢ precisione aggiornata ogni 10 min</span>
      <a href="https://openweathermap.org/" target="_blank" rel="noopener">API Pro</a>
    </footer>
  </aside>
</div>

<script>
const API_KEY="28a319d5da8a97fe0488bd10b1aaa1e6";
const BASE_URL="https://api.openweathermap.org/data/2.5";
const appShell=document.getElementById("appShell");
const cittaInternazionali=[
  "Roma,IT","Milano,IT","Torino,IT","Napoli,IT","New York,US",
  "London,GB","Paris,FR","Tokyo,JP","Sydney,AU","S√£o Paulo,BR"
];

window.addEventListener("load",()=>{
  const sel=document.getElementById("cittaInternazionale");
  cittaInternazionali.forEach(c=>{
    const o=document.createElement("option");
    o.value=c;o.textContent=c;sel.appendChild(o);
  });
  document.getElementById("cittaInternazionale").addEventListener("change",()=>{
    const v=document.getElementById("cittaInternazionale").value;
    if(v) fetchMeteo(`q=${encodeURIComponent(v)}`);
  });
  document.getElementById("citta").addEventListener("keypress",e=>{
    if(e.key==="Enter") cercaCitta();
  });
  if(navigator.onLine) setStatus(true); else setStatus(false);
  window.addEventListener("online",()=>setStatus(true));
  window.addEventListener("offline",()=>setStatus(false));
  const cached=localStorage.getItem("meteoProCurrent");
  const cachedForecast=localStorage.getItem("meteoProForecast");
  if(cached && cachedForecast){
    try{
      mostraMeteo(JSON.parse(cached),true);
      mostraPrevisioni(JSON.parse(cachedForecast),true);
    }catch(e){}
  }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      fetchMeteo(`lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
    },()=>{}, {timeout:6000,maxAge:600000});
  }
});

function setStatus(online){
  const dot=document.getElementById("statusDot");
  const text=document.getElementById("statusText");
  if(online){
    dot.className="status-dot ok";
    text.textContent="Online ‚Ä¢ stream dati aggiornato";
  }else{
    dot.className="status-dot offline";
    text.textContent="Offline ‚Ä¢ dati in cache";
  }
}

function mostraErrore(msg){
  const e=document.getElementById("error");
  e.textContent=msg;
  e.style.display="block";
  setTimeout(()=>e.style.display="none",5000);
}

function toggleLoading(show){
  document.getElementById("loadingSkel").classList.toggle("hidden",!show);
}

function parseFreeInput(value){
  value=value.trim();
  if(!value) return null;
  // formato "lat,lon"
  if(/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(value)){
    const [lat,lon]=value.split(",").map(Number);
    return `lat=${lat}&lon=${lon}`;
  }
  // altrimenti q=...
  return `q=${encodeURIComponent(value)}`;
}

function cercaCitta(){
  const v=document.getElementById("citta").value;
  const param=parseFreeInput(v);
  if(!param){mostraErrore("Inserisci una citt√†, CAP o coordinate valide.");return;}
  fetchMeteo(param);
}

function usaPosizione(){
  if(!navigator.geolocation){
    mostraErrore("Geolocalizzazione non supportata dal browser.");
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos=>fetchMeteo(`lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`),
    ()=>mostraErrore("Impossibile ottenere la posizione. Controlla i permessi."),
    {enableHighAccuracy:true,timeout:10000,maxAge:300000}
  );
}

async function fetchMeteo(param){
  toggleLoading(true);
  try{
    const [currentRes,forecastRes]=await Promise.all([
      fetch(`${BASE_URL}/weather?${param}&units=metric&lang=it&appid=${API_KEY}`),
      fetch(`${BASE_URL}/forecast?${param}&units=metric&lang=it&appid=${API_KEY}`)
    ]);
    if(!currentRes.ok) throw new Error("Localit√† non trovata o chiave API non valida.");
    const current=await currentRes.json();
    const forecast=await forecastRes.json();
    mostraMeteo(current,false);
    mostraPrevisioni(forecast,false);
    localStorage.setItem("meteoProCurrent",JSON.stringify(current));
    localStorage.setItem("meteoProForecast",JSON.stringify(forecast));
    document.getElementById("ultimoAgg").textContent="Ultimo aggiornamento: "+new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
  }catch(e){
    mostraErrore(e.message);
    console.error(e);
  }finally{
    toggleLoading(false);
  }
}

function getIcon(icon){
  const map={
    "01d":"‚òÄÔ∏è","01n":"üåô","02d":"üå§Ô∏è","02n":"‚òÅÔ∏è",
    "03d":"‚òÅÔ∏è","03n":"‚òÅÔ∏è","04d":"‚òÅÔ∏è","04n":"‚òÅÔ∏è",
    "09d":"üåßÔ∏è","09n":"üåßÔ∏è","10d":"üå¶Ô∏è","10n":"üåßÔ∏è",
    "11d":"‚õàÔ∏è","11n":"‚õàÔ∏è","13d":"‚ùÑÔ∏è","13n":"‚ùÑÔ∏è",
    "50d":"üå´Ô∏è","50n":"üå´Ô∏è"
  };
  return map[icon]||"üå§Ô∏è";
}

function mostraMeteo(d,fromCache=false){
  const meteo=document.getElementById("meteo");
  const sunrise=new Date(d.sys.sunrise*1000);
  const sunset=new Date(d.sys.sunset*1000);
  const now=new Date();
  const isNight=now < sunrise || now > sunset;
  appShell.style.background=isNight
    ? "linear-gradient(160deg,#020617,#000000)"
    : "linear-gradient(135deg,#020617,#020817)";
  const alba=sunrise.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
  const tramonto=sunset.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
  const feels=Math.round(d.main.feels_like);
  const temp=Math.round(d.main.temp);
  const delta=feels-temp;
  const deltaLabel=delta===0?"uguale":(delta>0?`+${delta}¬∞ pi√π caldo`:`${delta}¬∞ pi√π freddo`);
  const speed=d.wind.speed.toFixed(1);
  const gust=d.wind.gust?d.wind.gust.toFixed(1):null;
  const windLabel=`${speed} m/s${gust?` (raffiche ${gust} m/s)`:``}`;
  meteo.innerHTML=`
    <div class="card-header">
      <div class="location-block">
        <div class="location-name">${d.name}, ${d.sys.country}</div>
        <div class="location-meta">
          ${now.toLocaleDateString("it-IT",{weekday:"long",day:"2-digit",month:"short"})} ‚Ä¢
          Alba ${alba} ‚Ä¢ Tramonto ${tramonto}
        </div>
      </div>
      <span class="time-tag">${fromCache?"Cache locale":"Live now"}</span>
    </div>
    <div class="temp-block">
      <div class="temp-main">${temp}¬∞</div>
      <div class="temp-extra">
        <span>Percepita <strong>${feels}¬∞</strong> (${deltaLabel})</span>
        <span>Massima oggi <strong>${Math.round(d.main.temp_max)}¬∞</strong></span>
        <span>Minima oggi <strong>${Math.round(d.main.temp_min)}¬∞</strong></span>
      </div>
    </div>
    <div class="condition-row">
      <div class="condition-main">
        <span class="condition-icon">${getIcon(d.weather[0].icon)}</span>
        <span class="condition-label">${d.weather[0].description}</span>
      </div>
      <div class="chip-row">
        <span class="chip">Vento: <strong>${windLabel}</strong></span>
        <span class="chip">Umidit√†: <strong>${d.main.humidity}%</strong></span>
        <span class="chip">Pressione: <strong>${d.main.pressure} hPa</strong></span>
      </div>
    </div>
    <div class="metrics-grid">
      <div class="metric">
        <div class="metric-label"><span>Vento</span><span>m/s</span></div>
        <div class="metric-value">${speed}</div>
        <div class="metric-pill">${d.wind.deg?`Direzione ${d.wind.deg}¬∞`:"Variabile"}</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span>Umidit√†</span><span>%</span></div>
        <div class="metric-value">${d.main.humidity}</div>
        <div class="metric-pill">${d.main.humidity>80?"Aria molto umida":"Comfort accettabile"}</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span>Pressione</span><span>hPa</span></div>
        <div class="metric-value">${d.main.pressure}</div>
        <div class="metric-pill">${d.main.pressure<1010?"Tendenza instabile":"Tendenza stabile"}</div>
      </div>
    </div>
  `;
  // Dettagli atmosfera derivati:
  document.getElementById("visValue").textContent=d.visibility?`${(d.visibility/1000).toFixed(1)} km`:"‚Äî";
  document.getElementById("cloudValue").textContent=(d.clouds && typeof d.clouds.all==="number")?`${d.clouds.all}%`:"‚Äî";
  // Mock UV e AQI basati su condizioni (pronti per One Call/AQ API reali)
  const uvEl=document.getElementById("uvValue");
  const aqiEl=document.getElementById("aqiValue");
  const baseUV=isNight?0:Math.min(11,Math.max(1,Math.round((100-d.clouds.all)/10)));
  uvEl.textContent=`Indice ${baseUV}`;
  uvEl.parentElement.className="detail-badge "+(baseUV<=3?"good":baseUV<=7?"moderate":"bad");
  const mockAQI=Math.max(1,Math.min(5,Math.round(d.main.humidity/20)));
  const labelAQI=["‚Äî","Ottimo","Buono","Discreto","Scadente","Pessimo"][mockAQI];
  aqiEl.textContent=`${labelAQI} (${mockAQI})`;
  aqiEl.parentElement.className="detail-badge "+(mockAQI<=2?"good":mockAQI===3?"moderate":"bad");
}

function mostraPrevisioni(d,fromCache=false){
  const daysMap={};
  d.list.forEach(item=>{
    const day=item.dt_txt.split(" ")[0];
    if(!daysMap[day]) daysMap[day]=[];
    daysMap[day].push(item);
  });
  const keys=Object.keys(daysMap).slice(0,5);
  const forecastDiv=document.getElementById("previsioni");
  forecastDiv.innerHTML="";
  const labels=[],tempsMin=[],tempsMax=[];
  const hourlyContainer=document.getElementById("hourlyList");
  hourlyContainer.innerHTML="";
  const now=new Date();
  const firstDay=daysMap[keys[0]];
  // hourly: prossime 12 ore da forecast (ogni 3h)
  const nextHours=d.list.slice(0,6);
  let rainRiskCount=0;
  nextHours.forEach(item=>{
    const dt=new Date(item.dt*1000);
    const hour=dt.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
    const temp=item.main.temp;
    const pop=Math.round((item.pop||0)*100);
    if(pop>=40) rainRiskCount++;
    hourlyContainer.innerHTML+=`
      <div class="hour-pill">
        <div class="h-time">${hour}</div>
        <div class="h-icon">${getIcon(item.weather[0].icon)}</div>
        <div class="h-temp">${Math.round(temp)}¬∞</div>
        <div class="h-pop">${pop}% pioggia</div>
      </div>
    `;
  });
  document.getElementById("hourlySummary").textContent=rainRiskCount>0
    ? `${rainRiskCount} intervalli con pioggia probabile`
    : "Nessuna pioggia significativa prevista";
  // daily cards
  keys.forEach((day,index)=>{
    const arr=daysMap[day];
    const minTemp=Math.min(...arr.map(x=>x.main.temp_min));
    const maxTemp=Math.max(...arr.map(x=>x.main.temp_max));
    const date=new Date(day+"T00:00:00");
    const label=date.toLocaleDateString("it-IT",{weekday:"short",day:"2-digit"});
    labels.push(label);
    tempsMin.push(minTemp);
    tempsMax.push(maxTemp);
    const mid=arr[Math.min(4,arr.length-1)];
    const desc=mid.weather[0].description;
    const icon=mid.weather[0].icon;
    forecastDiv.innerHTML+=`
      <div class="day-pill">
        <div class="day-main">
          <div class="day-name">${index===0?"Oggi":label}</div>
          <div class="day-icon">${getIcon(icon)}</div>
          <div class="day-desc">${desc}</div>
        </div>
        <div class="day-temps">
          <div class="day-max">${Math.round(maxTemp)}¬∞</div>
          <div class="day-min">${Math.round(minTemp)}¬∞</div>
        </div>
      </div>
    `;
  });
  disegnaGrafico(labels,tempsMin,tempsMax);
}

function disegnaGrafico(labels,min,max){
  const canvas=document.getElementById("grafico");
  const ctx=canvas.getContext("2d");
  const dpr=window.devicePixelRatio||1;
  const cssW=canvas.clientWidth||canvas.offsetWidth;
  const cssH=canvas.clientHeight||canvas.offsetHeight||130;
  canvas.width=cssW*dpr;
  canvas.height=cssH*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,cssW,cssH);
  const leftPad=26,rightPad=10,topPad=14,bottomPad=18;
  const plotW=cssW-leftPad-rightPad;
  const plotH=cssH-topPad-bottomPad;
  const maxT=Math.max(...max)+2;
  const minT=Math.min(...min)-2;
  const range=maxT-minT||1;
  // griglia orizzontale
  ctx.strokeStyle="rgba(55,65,81,.8)";
  ctx.lineWidth=1;
  ctx.setLineDash([4,4]);
  const steps=4;
  for(let i=0;i<=steps;i++){
    const y=topPad+plotH*(i/steps);
    ctx.beginPath();
    ctx.moveTo(leftPad,y);
    ctx.lineTo(cssW-rightPad,y);
    ctx.stroke();
    const t=maxT - range*(i/steps);
    ctx.fillStyle="#6b7280";
    ctx.font="10px system-ui";
    ctx.textAlign="right";
    ctx.textBaseline="middle";
    ctx.fillText(Math.round(t)+"¬∞",leftPad-4,y);
  }
  ctx.setLineDash([]);
  // linee
  const stepX=plotW/(labels.length-1||1);
  function yForTemp(t){return topPad+plotH*((maxT-t)/range);}
  ctx.lineJoin="round";
  // max
  ctx.beginPath();
  labels.forEach((_,i)=>{
    const x=leftPad+i*stepX;
    const y=yForTemp(max[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle="rgba(56,189,248,.9)";
  ctx.lineWidth=2.4;
  ctx.shadowColor="rgba(56,189,248,.7)";
  ctx.shadowBlur=16;
  ctx.stroke();
  ctx.shadowBlur=0;
  // min
  ctx.beginPath();
  labels.forEach((_,i)=>{
    const x=leftPad+i*stepX;
    const y=yForTemp(min[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle="rgba(59,130,246,.9)";
  ctx.lineWidth=2;
  ctx.stroke();
  // punti ed etichette
  labels.forEach((label,i)=>{
    const x=leftPad+i*stepX;
    const yMax=yForTemp(max[i]);
    const yMin=yForTemp(min[i]);
    ctx.fillStyle="#0f172a";
    ctx.strokeStyle="rgba(148,163,184,.9)";
    ctx.lineWidth=1.5;
    ctx.beginPath();
    ctx.arc(x,yMax,5,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(x,yMin,4,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle="#e5e7eb";
    ctx.font="10px system-ui";
    ctx.textAlign="center";
    ctx.textBaseline="top";
    ctx.fillText(label,x,cssH-15);
  });
}

// PWA SW placeholder (ready for real file)
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(()=>{});
}
</script>
</body>
</html>
